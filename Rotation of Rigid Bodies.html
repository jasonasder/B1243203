<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Rotation of Rigid Bodies</title>
    <style>
        :root {
            --nav-bg: #2c3e50;
            --theory-bg: rgba(255, 255, 255, 0.98);
            --lab-bg: #2b323a;
            --accent-green: #51cf66; 
            --accent-orange: #ff922b; 
            --accent-purple: #cc5de8; 
            --accent-blue: #339af0;
            --accent-red: #fa5252;
            --text-main: #343a40;
        }
        
        * { box-sizing: border-box; }
        body {
            margin: 0; padding: 0;
            font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
            background: url('img/bb.webp') no-repeat center center fixed;
            background-size: cover;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        nav {
            height: 60px; background: var(--nav-bg);
            display: flex; align-items: center; padding: 0 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 100;
        }
        nav a { color: #dee2e6; text-decoration: none; margin-right: 25px; font-weight: bold; font-size: 15px; transition: 0.3s; }
        nav a:hover { color: var(--accent-green); }
        nav a.active { color: var(--accent-green); border-bottom: 2px solid var(--accent-green); }

        #main-container {
            flex-grow: 1; display: flex; padding: 15px; gap: 15px;
            height: calc(100vh - 60px);
        }

        #theory-card {
            width: 400px; background: var(--theory-bg);
            border-radius: 12px; padding: 20px; overflow-y: auto;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }

        #experiment-card {
            flex-grow: 1; background: var(--theory-bg);
            border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; overflow: hidden;
        }

        .mode-tabs {
            display: flex; background: #e9ecef; border-bottom: 1px solid #dee2e6;
            border-radius: 12px 12px 0 0; overflow: hidden;
        }
        .mode-tab {
            flex: 1; padding: 15px; text-align: center; cursor: pointer;
            font-weight: bold; color: #666; transition: 0.3s;
            border-bottom: 3px solid transparent;
        }
        .mode-tab:hover { background: #dee2e6; }
        .mode-tab.active {
            background: #fff; color: var(--accent-blue);
            border-bottom: 3px solid var(--accent-blue);
        }
        .mode-tab.active.safety { color: var(--accent-red); border-bottom-color: var(--accent-red); }

        #exp-header {
            padding: 15px 20px; background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex; align-items: center; gap: 20px; flex-wrap: wrap;
        }

        select {
            appearance: none; background-color: #fff; border: 1px solid #ced4da;
            border-radius: 6px; padding: 6px 30px 6px 12px; font-size: 14px;
            color: #495057; cursor: pointer;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat; background-position: right 8px center; background-size: 14px;
        }
        select:focus { outline: none; border-color: var(--accent-blue); }

        .control-group { display: flex; flex-direction: column; align-items: flex-start; gap: 4px; margin-right: 15px; }
        .slider-label { font-size: 12px; font-weight: bold; color: #555; }
        input[type="range"] { width: 110px; cursor: pointer; height: 6px; border-radius: 3px; background: #dee2e6; outline: none; appearance: none; }
        input[type="range"]::-webkit-slider-thumb { appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--accent-blue); cursor: pointer; transition: 0.2s; }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        .modal {
            display: none; position: fixed; z-index: 2000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); backdrop-filter: blur(3px);
        }
        .modal-content {
            background-color: #fff; margin: 10% auto; padding: 25px;
            border-radius: 12px; width: 60%; max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4); animation: slideIn 0.3s;
        }
        @keyframes slideIn { from {transform: translateY(-50px); opacity:0;} to {transform: translateY(0); opacity:1;} }
        
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 15px;
        }
        .modal-title { font-size: 24px; font-weight: bold; color: var(--text-main); }
        
        #success-toast {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(40, 40, 40, 0.95); color: white;
            padding: 20px 40px; border-radius: 10px; text-align: center;
            display: none; z-index: 2000; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: fadeInOut 1.5s ease-in-out;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -40%); }
            15% { opacity: 1; transform: translate(-50%, -50%); }
            85% { opacity: 1; transform: translate(-50%, -50%); }
            100% { opacity: 0; transform: translate(-50%, -60%); }
        }
        .checkmark { font-size: 40px; color: var(--accent-green); display: block; margin-bottom: 10px; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background-color: var(--nav-bg); color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        .close-btn { font-size: 28px; cursor: pointer; color: #aaa; }
        .close-btn:hover { color: #000; }

        #canvas-container {
            flex-grow: 1; position: relative;
            background: var(--lab-bg); margin: 10px;
            border-radius: 8px; border: 1px solid #454d55; overflow: hidden;
            cursor: default;
        }
        canvas { width: 100%; height: 100%; display: block; }

        #telemetry {
            position: absolute; top: 15px; right: 15px;
            background: rgba(33, 37, 41, 0.9); 
            color: #ecf0f1; 
            padding: 15px; border-radius: 6px; font-family: 'Consolas', monospace;
            font-size: 14px; border-left: 4px solid var(--accent-purple);
            pointer-events: none;
            min-width: 220px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        #hint-msg {
            position: absolute; bottom: 20px; left: 20px;
            color: rgba(255,255,255,0.7); font-size: 14px;
            pointer-events: none;
        }

        h1 { font-size: 40px; color: var(--text-main); margin: 0 0 10px 0; border-bottom: 3px solid var(--accent-purple); padding-bottom: 5px; }
        h2 { font-size: 20px; color: #1a5276; margin-top: 20px; border-left: 5px solid #1a5276; padding-left: 10px; }
        p { color: #444; line-height: 1.6; font-size: 16px; text-align: justify; margin: 5px 0; }
        
        .formula-box { 
            background: #f8f9fa; padding: 12px; border-radius: 6px; 
            font-size: 15px; border: 1px solid #e9ecef; margin-top: 8px; 
            font-family: "Times New Roman", serif; line-height: 1.6;
        }

        button { 
            background: var(--accent-blue); color: white; border: none; padding: 8px 18px; 
            border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 13px;
        }
        button:hover { background: #228be6; transform: translateY(-2px); }
        .btn-record { background: var(--accent-green); }
        .btn-record:hover { background: #40c057; }
        .btn-reset { background: #868e96; }
        .btn-reset:hover { background: #495057; }

        .hidden { display: none !important; }

        #quiz-area button { width: 100%; margin: 5px 0; text-align: left; background: #e9ecef; color: #333; }
        #quiz-area button:hover { background: #dee2e6; transform: none; }
    </style>
</head>
<body>

<div id="main-container">
    <div id="theory-card">
        <h1>åœ“å‘¨é‹å‹•</h1>
        
        <h2>å®šå¾‹å…§å®¹</h2>
        <p>å‹»é€Ÿåœ“å‘¨é‹å‹•ï¼ˆUniform Circular Motionï¼‰æŒ‡ç‰©é«”ä»¥æ†å®šçš„é€Ÿç‡ï¼Œæ²¿è‘—åœ“å½¢è»Œé“é‹è¡Œçš„é‹å‹•ã€‚</p>
        <p>å„˜ç®¡é€Ÿç‡ï¼ˆSpeedï¼‰ä¸è®Šï¼Œä½†å› é€Ÿåº¦ï¼ˆVelocityï¼‰çš„æ–¹å‘éš¨æ™‚åœ¨æ”¹è®Šï¼Œæ•…ç‰©é«”éš¨æ™‚å…·æœ‰æŒ‡å‘åœ“å¿ƒçš„åŠ é€Ÿåº¦ã€‚</p>
        
        <h2>å…¬å¼è¡¨ç¤º</h2>
        <div class="formula-box">
            <b>åŸºæœ¬å®šç¾©ï¼š</b><br>
            è§’é€Ÿåº¦ï¼šÏ‰ = 2Ï€ / T (rad/s)<br>
            ç·šé€Ÿåº¦ï¼šv = Ï‰ Â· r<br>
            é€±æœŸï¼šT = 2Ï€ / Ï‰ (s)<br>
        </div>
        <div class="formula-box">
            <b>å‹•åŠ›å­¸ï¼š</b><br>
            å‘å¿ƒåŠ é€Ÿåº¦ï¼ša<sub>c</sub> = vÂ² / r = Ï‰Â² Â· r<br>
            å‘å¿ƒåŠ›ï¼šF<sub>c</sub> = m Â· a<sub>c</sub>
        </div>

        <h2>å‘é‡æ–¹å‘</h2>
        <p>
            <b>1. é€Ÿåº¦ (v)ï¼š</b> å§‹çµ‚æ²¿è‘—åœ“å‘¨çš„<b>åˆ‡ç·šæ–¹å‘</b>ï¼ˆç¶ è‰²ï¼‰ã€‚<br>
            <b>2. åŠ é€Ÿåº¦ (a) & åŠ› (F)ï¼š</b> å§‹çµ‚æŒ‡å‘<b>åœ“å¿ƒ</b>ï¼ˆæ©˜è‰²èˆ‡ç´«è‰²ï¼‰ï¼Œè² è²¬æ”¹è®Šé€Ÿåº¦çš„æ–¹å‘è€Œéå¤§å°ã€‚
        </p>

        <h2>å¸¸è¦‹æ‡‰ç”¨</h2>
        <p>1. <b>å¤©é«”é‹è¡Œï¼š</b> è¡Œæ˜Ÿç¹æ—¥ã€è¡›æ˜Ÿç¹åœ°ã€‚<br>
           2. <b>å·¥æ¥­æ©Ÿæ¢°ï¼š</b> é£›è¼ªã€é›¢å¿ƒåˆ†é›¢æ©Ÿã€‚<br>
           3. <b>æ—¥å¸¸ç”Ÿæ´»ï¼š</b> æ´—è¡£æ©Ÿè„«æ°´ã€æ—‹è½‰æœ¨é¦¬ã€‚</p>

        <h2>éš¨å ‚æ¸¬é©—</h2>
        <div id="quiz-area" style="font-size: 14px; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
            <p><b>Q1: è‹¥åŠå¾‘ r å›ºå®šï¼Œè§’é€Ÿåº¦ Ï‰ è®Šç‚º 2 å€ï¼Œå‘å¿ƒåŠ› F æœƒè®Šç‚ºå¹¾å€ï¼Ÿ</b></p>
            <button onclick="checkQuiz(this, false)">2 å€</button>
            <button onclick="checkQuiz(this, true)">4 å€</button>
            <button onclick="checkQuiz(this, false)">ä¸è®Š</button>
            <p id="quiz-feedback" style="margin-top:10px; font-weight:bold;"></p>
        </div>
    </div>

    <div id="experiment-card">
        <div class="mode-tabs">
            <div class="mode-tab active" id="tab-std" onclick="switchMode('standard')">ğŸ”¬ åŸºç¤æ¢ç´¢æ¨¡å¼</div>
            <div class="mode-tab" id="tab-safe" onclick="switchMode('safety')">ğŸï¸ è³½è»Šå®‰å…¨æ¨¡å¼</div>
        </div>

        <div id="exp-header">
            <div class="control-group">
                <span class="slider-label">åŠå¾‘ r: <span id="rDisp">50</span> m</span>
                <input type="range" id="r" min="10" max="100" step="1" value="50" oninput="updateParams()">
            </div>
            <div class="control-group">
                <span class="slider-label">è§’é€Ÿåº¦ Ï‰: <span id="omegaDisp">2.0</span> rad/s</span>
                <input type="range" id="omega" min="0.1" max="6.0" step="0.1" value="2.0" oninput="updateParams()">
            </div>
            <div class="control-group">
                <span class="slider-label">è³ªé‡ m: <span id="mDisp">1000</span> kg</span>
                <input type="range" id="mass" min="100" max="2000" step="100" value="1000" oninput="updateParams()">
            </div>

            <div class="control-group std-ctrl">
                <span class="slider-label">é¡¯ç¤ºå‘é‡ (Vectors)</span>
                <select id="showVec" onchange="drawScene()">
                    <option value="all">å…¨éƒ¨é¡¯ç¤º</option>
                    <option value="v">åƒ…é€Ÿåº¦ (v)</option>
                    <option value="a">åƒ…åŠ é€Ÿåº¦ (ac)</option>
                    <option value="F">åƒ…å‘å¿ƒåŠ› (Fc)</option>
                </select>
            </div>
            
            <div class="control-group safe-ctrl hidden" style="border-left: 1px solid #ddd; padding-left: 10px;">
                <span class="slider-label" style="color:#d35400">è·¯é¢æ‘©æ“¦æ¥µé™ (ä¾›çµ¦)</span>
                <input type="range" id="frictionLimit" min="100000" max="600000" step="10000" value="300000" oninput="updateMaxForce()">
                <div style="font-size:10px; color:#666;">Max: <span id="frictionDisp">300000</span> N</div>
            </div>

            <div style="margin-left:auto; display:flex; gap:8px;">
                <button class="btn-record" onclick="recordData()">ç´€éŒ„</button>
                <button class="btn-reset" onclick="resetSim()">é‡ç½®</button>
                <button onclick="openRecordModal()" style="background: #333;">ç´€éŒ„ç°¿</button>
            </div>
        </div>

        <div id="canvas-container">
            <div id="success-toast"><span class="checkmark">âœ”</span><div>æ•¸æ“šå·²æˆåŠŸç´€éŒ„</div></div>
            <div id="hint-msg">ğŸ’¡ æç¤ºï¼šè©¦è‘—èª¿æ•´åŠå¾‘èˆ‡è§’é€Ÿåº¦ï¼Œè§€å¯Ÿå‘å¿ƒåŠ›çš„æ•¸å€¼è®ŠåŒ–ã€‚</div>

            <div id="telemetry">
                <span style="color:var(--accent-green)">Velocity (v):</span> <span id="vVal" style="color:white; font-weight:bold;">0.00</span> m/s<br>
                <span style="color:var(--accent-orange)">Accel (ac):</span> <span id="aVal" style="color:white; font-weight:bold;">0.00</span> m/sÂ²<br>
                <span style="color:var(--accent-purple)">Force (Fc):</span> <span id="FVal" style="color:white; font-weight:bold;">0.00</span> N<br>
                <hr style="border-color:#555; margin:5px 0;">
                <div id="safety-status" style="font-size: 12px; color: #51cf66;">ç‹€æ…‹: å®‰å…¨</div>
            </div>
            
            <canvas id="c"></canvas>
        </div>
    </div>
</div>

<div id="recordModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 style="margin:0;">ğŸ“” å¯¦é©—ç´€éŒ„ç°¿</h2>
            <div style="display: flex; gap: 15px; align-items: center;">
                <button onclick="clearRecords()" style="background: var(--accent-red); padding: 5px 15px; font-size: 13px;">æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button>
                <span class="close-btn" onclick="closeModal('recordModal')">&times;</span>
            </div>
        </div>
        <table id="recordTable">
            <thead>
                <tr>
                    <th>æ™‚é–“</th>
                    <th>æ¨¡å¼</th>
                    <th>åŠå¾‘ r</th>
                    <th>è§’é€Ÿåº¦ Ï‰</th>
                    <th>å‘å¿ƒåŠ› Fc</th>
                    <th>æ‘©æ“¦æ¥µé™</th>
                    <th>çµæœ</th>
                </tr>
            </thead>
            <tbody id="recordBody"></tbody>
        </table>
    </div>
</div>

<div id="skidInfoModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2 class="modal-title" style="color: var(--accent-orange);">ğŸï¸ è³½è»Šéå½ç‰©ç†</h2>
            <span class="close-btn" onclick="closeModal('skidInfoModal')">&times;</span>
        </div>
        <div style="font-size: 16px; line-height: 1.6; color: #444;">
            <p>è»Šè¼›è½‰å½æ™‚ï¼Œã€Œéœ€æ±‚å‘å¿ƒåŠ›ã€å¿…é ˆç”±è¼ªèƒèˆ‡åœ°é¢çš„ã€Œæœ€å¤§éœæ‘©æ“¦åŠ›ã€ä¾†æä¾›ï¼ˆä¾›çµ¦ï¼‰ã€‚</p>
            <div class="formula-box" style="margin: 15px 0; font-family: 'Times New Roman', serif;">
                éœ€æ±‚ (Demand): F<sub>c</sub> = m Â· Ï‰<sup>2</sup> Â· r<br>
                ä¾›çµ¦ (Supply): f<sub>max</sub> = Î¼<sub>s</sub> Â· N
            </div>
            <p><b>æ‰“æ»‘å¤±æ§ï¼š</b></p>
            <p>ç•¶ <b>éœ€æ±‚ > ä¾›çµ¦</b> æ™‚ï¼Œæ‘©æ“¦åŠ›æ‹‰ä¸ä½è»Šå­ï¼Œç‰©ç†å­¸ä¸Šç„¡æ³•ç¶­æŒåœ“å‘¨é‹å‹•ï¼Œè»Šå­æœƒä¾ç…§<b>æ…£æ€§ (Newton's 1st Law)</b> æ²¿åˆ‡ç·šæ–¹å‘é£›å‡ºã€‚</p>
            <button onclick="closeModal('skidInfoModal')" style="width:100%; margin-top:10px; padding:12px;">æˆ‘ç­è§£äº†ï¼Œé–‹å§‹å¯¦é©—</button>
        </div>
    </div>
</div>

<div id="crashModal" class="modal" style="z-index: 2500;">
    <div class="modal-content" style="max-width: 500px; border: 3px solid var(--accent-red);">
        <div class="modal-header" style="border-bottom-color: var(--accent-red);">
            <h2 class="modal-title" style="color: var(--accent-red);">âš ï¸ å¤±æ§æ‰“æ»‘ (Skidding)</h2>
        </div>
        <div style="font-size: 16px; line-height: 1.6; color: #444;">
            <p style="font-size:18px; font-weight:bold;">ç‚ºä»€éº¼æœƒé£›å‡ºå»ï¼Ÿ</p>
            <p>ç•¶å‰çš„<b>å‘å¿ƒåŠ›éœ€æ±‚ (Demand)</b> å·²ç¶“è¶…éäº†è¼ªèƒèƒ½æä¾›çš„<b>æœ€å¤§éœæ‘©æ“¦åŠ› (Supply)</b>ã€‚</p>
            <ul style="background:#fff5f5; padding:15px 30px; border-radius:8px;">
                <li>æ‘©æ“¦åŠ›æ‹‰ä¸ä½è»Šå­ã€‚</li>
                <li>æ ¹æ“š<b>ç‰›é “ç¬¬ä¸€é‹å‹•å®šå¾‹ (æ…£æ€§)</b>ï¼Œç‰©é«”å‚¾å‘ä¿æŒç›´ç·šé‹å‹•ã€‚</li>
                <li>å› æ­¤è»Šè¼›æ²¿è‘—åˆ‡ç·šæ–¹å‘é£›å‡ºã€‚</li>
            </ul>
            <p><b>ğŸ’¡ å®‰å…¨å»ºè­°ï¼š</b>è«‹å˜—è©¦é™ä½è§’é€Ÿåº¦ (Ï‰) æˆ–å¢å¤§è½‰å½åŠå¾‘ (r)ã€‚</p>
            <button onclick="resetSim(); closeModal('crashModal');" style="width:100%; margin-top:10px; padding:12px; background:var(--accent-red);">é‡ç½®æ¨¡æ“¬ (Reset)</button>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');
    const COLOR_V = '#51cf66';
    const COLOR_A = '#ff922b';
    const COLOR_F = '#cc5de8';

    let currentMode = 'standard';
    let r_val = 50; 
    let omega_val = 2.0; 
    let m_val = 1000.0; 
    let angle = 0;

    let isSkidding = false;
    let skidX = 0, skidY = 0;
    let skidVx = 0, skidVy = 0;
    let maxForce = 300000; 

    const scale = 3.0; 
    let centerX, centerY;

    let records = [];

    function resize() {
        canvas.width = canvas.parentElement.clientWidth;
        canvas.height = canvas.parentElement.clientHeight;
        centerX = canvas.width / 2;
        centerY = canvas.height / 2;
        if(!isSkidding) drawScene();
    }

    function switchMode(mode) {
        currentMode = mode;
        if (mode === 'safety') {
            r_val = 50; 
            omega_val = 2.0;
            m_val = 1000.0;
            document.getElementById('r').value = 50;
            document.getElementById('omega').value = 2.0;
            document.getElementById('mass').value = 1000;
        }

        resetSim(); 

        document.getElementById('tab-std').classList.toggle('active', mode === 'standard');
        document.getElementById('tab-safe').classList.toggle('active', mode === 'safety');
        if (mode === 'safety') document.getElementById('tab-safe').classList.add('safety');
        else document.getElementById('tab-safe').classList.remove('safety');

        if (mode === 'standard') {
            document.querySelector('.std-ctrl').classList.remove('hidden');
            document.querySelector('.safe-ctrl').classList.add('hidden');
            document.getElementById('hint-msg').innerText = "ğŸ’¡ æç¤ºï¼šè©¦è‘—èª¿æ•´åŠå¾‘èˆ‡è§’é€Ÿåº¦ï¼Œè§€å¯Ÿå‘å¿ƒåŠ›çš„æ•¸å€¼è®ŠåŒ–ã€‚";
        } else {
            document.querySelector('.std-ctrl').classList.add('hidden');
            document.querySelector('.safe-ctrl').classList.remove('hidden');
            document.getElementById('hint-msg').innerText = "âš ï¸ è­¦å‘Šï¼šè«‹æ³¨æ„å³æ–¹æ‘©æ“¦åŠ›è² è·ï¼Œé¿å…è¶…é€Ÿæ‰“æ»‘ï¼";
            document.getElementById('skidInfoModal').style.display = "block";
        }
        updateParams();
    }

    function updateMaxForce() {
        maxForce = parseInt(document.getElementById('frictionLimit').value);
        document.getElementById('frictionDisp').innerText = maxForce;
        updateParams();
    }

    function updateParams() {
        if(isSkidding) return;

        r_val = parseFloat(document.getElementById('r').value);
        omega_val = parseFloat(document.getElementById('omega').value);
        m_val = parseFloat(document.getElementById('mass').value);

        document.getElementById('rDisp').innerText = r_val.toFixed(0);
        document.getElementById('omegaDisp').innerText = omega_val.toFixed(1);
        document.getElementById('mDisp').innerText = m_val.toFixed(0);

        checkSafetyAndLoad();
        updateTelemetry();
    }

    function checkSafetyAndLoad() {
        const ac = omega_val * omega_val * r_val;
        const Fc = m_val * ac;
        const statusEl = document.getElementById('safety-status');
        
        let percent = (Fc / maxForce) * 100;
        
        if (currentMode === 'safety') {
            if (Fc > maxForce) {
                startSkid();
                statusEl.innerHTML = "ç‹€æ…‹: <b style='color:#fa5252'>å±éšª (DANGER)</b>";
            } else {
                let color = percent > 80 ? "#ff922b" : "#51cf66";
                statusEl.innerHTML = `æ‘©æ“¦åŠ›è² è·: <b style='color:${color}'>${percent.toFixed(0)}%</b>`;
            }
        } else {
            if (Fc > maxForce) {
                statusEl.innerHTML = `æ‘©æ“¦åŠ›è² è·: <b style='color:#fa5252'>âš ï¸ ç‰©ç†ä¸å¯èƒ½ (>100%)</b>`;
            } else {
                statusEl.innerHTML = `æ‘©æ“¦åŠ›è² è·: <b style='color:#339af0'>${percent.toFixed(0)}%</b> (ç†è«–å€¼)`;
            }
        }
    }

    function startSkid() {
        isSkidding = true;
        const r_px = r_val * scale;
        skidX = centerX + r_px * Math.cos(angle);
        skidY = centerY + r_px * Math.sin(angle);
        
        const v = omega_val * r_val * scale; 
        skidVx = -Math.sin(angle) * v; 
        skidVy = Math.cos(angle) * v; 

        document.getElementById('r').disabled = true;
        document.getElementById('omega').disabled = true;
        setTimeout(() => {
            document.getElementById('crashModal').style.display = "block";
        }, 800); 
    }

    function updateTelemetry() {
        const v = omega_val * r_val;
        const ac = omega_val * omega_val * r_val;
        const Fc = m_val * ac;
        
        document.getElementById('vVal').innerText = v.toFixed(2);
        document.getElementById('aVal').innerText = ac.toFixed(2);
        document.getElementById('FVal').innerText = Fc.toFixed(0);
    }

    function drawScene() {
        ctx.fillStyle = 'rgba(43, 50, 58, 0.3)'; 
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.strokeStyle = "rgba(255,255,255,0.1)";
        ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(centerX, 0); ctx.lineTo(centerX, canvas.height); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0, centerY); ctx.lineTo(canvas.width, centerY); ctx.stroke();

        const r_px = r_val * scale;
        
        ctx.beginPath();
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
        ctx.setLineDash([5, 5]);
        ctx.lineWidth = 2;
        ctx.arc(centerX, centerY, r_px, 0, Math.PI * 2);
        ctx.stroke();
        ctx.setLineDash([]); 

        let px, py, carAngle;

        if (isSkidding) {
            px = skidX; py = skidY;
            skidX += skidVx * 0.016; skidY += skidVy * 0.016;
            carAngle = Math.atan2(skidVy, skidVx) + Math.PI/2; 
        } else {
            px = centerX + r_px * Math.cos(angle);
            py = centerY + r_px * Math.sin(angle);
            
            ctx.beginPath();
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
            ctx.lineWidth = 2;
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(px, py);
            ctx.stroke();
            carAngle = angle + Math.PI/2; 
        }

        if (currentMode === 'safety') {
            drawCar(px, py, carAngle);
        } else {
            ctx.beginPath();
            ctx.fillStyle = '#339af0';
            ctx.shadowBlur = 10; ctx.shadowColor = '#339af0';
            ctx.arc(px, py, 12, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;
        }

        if (currentMode === 'standard' && !isSkidding) {
            const vecMode = document.getElementById('showVec').value;
            const v = omega_val * r_val;
            const ac = omega_val * omega_val * r_val;
            const Fc = m_val * ac;

            if (vecMode === 'all' || vecMode === 'v') {
                const vLen = Math.min(100, v * 0.5);
                const tx = -Math.sin(angle); const ty = Math.cos(angle);
                drawArrow(px, py, px + tx * vLen, py + ty * vLen, COLOR_V);
            }
            if (vecMode === 'all' || vecMode === 'a') {
                let aLen = ac * 0.4; 
                if (aLen < 30) aLen = 30; 
                if (aLen > r_px * 0.85) aLen = r_px * 0.85; 
                const ux = -Math.cos(angle); const uy = -Math.sin(angle);
                drawArrow(px, py, px + ux * aLen, py + uy * aLen, COLOR_A);
            }
            if (vecMode === 'all' || vecMode === 'F') {
                let fLen = Fc * 0.0004;
                if (fLen < 30) fLen = 30; 
                if (fLen > r_px * 0.85) fLen = r_px * 0.85; 
                const ux = -Math.cos(angle); const uy = -Math.sin(angle);
                const offset = (vecMode==='all') ? 6 : 0; 
                drawArrow(px, py-offset, px + ux * fLen, py + uy * fLen - offset, COLOR_F);
            }
        }

        ctx.beginPath(); ctx.fillStyle = '#eee'; ctx.arc(centerX, centerY, 5, 0, Math.PI * 2); ctx.fill();
    }

    function drawCar(x, y, rotation) {
        ctx.save(); ctx.translate(x, y); ctx.rotate(rotation);
        ctx.fillStyle = isSkidding ? '#fa5252' : '#f03e3e';
        ctx.fillRect(-10, -20, 20, 40); 
        ctx.fillStyle = '#222';
        ctx.fillRect(-12, -18, 4, 10); ctx.fillRect(8, -18, 4, 10); 
        ctx.fillRect(-12, 8, 4, 10); ctx.fillRect(8, 8, 4, 10); 
        ctx.fillStyle = '#333'; ctx.fillRect(-10, 15, 20, 5);
        ctx.beginPath(); ctx.fillStyle = '#ffd43b'; ctx.arc(0, 0, 5, 0, Math.PI*2); ctx.fill();
        ctx.restore();
    }

    function drawArrow(x1, y1, x2, y2, color) {
        ctx.beginPath(); ctx.strokeStyle = color; ctx.fillStyle = color; ctx.lineWidth = 3;
        ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke();
        const headLen = 10; const a = Math.atan2(y2 - y1, x2 - x1);
        ctx.beginPath(); ctx.moveTo(x2, y2);
        ctx.lineTo(x2 - headLen * Math.cos(a - Math.PI/6), y2 - headLen * Math.sin(a - Math.PI/6));
        ctx.lineTo(x2 - headLen * Math.cos(a + Math.PI/6), y2 - headLen * Math.sin(a + Math.PI/6));
        ctx.fill();
    }

    function animate() {
        if (!isSkidding) angle += omega_val * 0.016;
        drawScene(); 
        requestAnimationFrame(animate);
    }

    function resetSim() {
        isSkidding = false;
        document.getElementById('r').disabled = false;
        document.getElementById('omega').disabled = false;
        if (currentMode === 'safety') {
            r_val = 50; omega_val = 2.0; m_val = 1000.0;
            document.getElementById('r').value = 50;
            document.getElementById('omega').value = 2.0;
            document.getElementById('mass').value = 1000;
        } else {
            r_val = 50; omega_val = 2.0; m_val = 1000.0;
            document.getElementById('r').value = 50;
            document.getElementById('omega').value = 2.0;
            document.getElementById('mass').value = 1000;
        }
        
        angle = 0;
        ctx.clearRect(0,0,canvas.width, canvas.height);
        updateParams();
    }

    function recordData() {
        const Fc = (m_val * omega_val * omega_val * r_val).toFixed(0);
        const result = isSkidding ? "å¤±æ§" : "å®‰å…¨";
        const modeStr = currentMode === 'standard' ? "åŸºç¤" : "è³½è»Š";
        const limitStr = currentMode === 'standard' ? "N/A" : maxForce;

        records.push({
            time: new Date().toLocaleTimeString(),
            mode: modeStr, r: r_val, omega: omega_val, Fc, limit: limitStr, result
        });

        const toast = document.getElementById('success-toast');
        toast.style.display = 'block';
        toast.style.animation = 'none';
        toast.offsetHeight; 
        toast.style.animation = 'fadeInOut 1.5s ease-in-out';
        setTimeout(() => { toast.style.display = 'none'; }, 1500);
    }

    function openRecordModal() {
        const tbody = document.getElementById('recordBody');
        tbody.innerHTML = records.map(r => `
            <tr>
                <td>${r.time}</td>
                <td>${r.mode}</td>
                <td>${r.r}</td>
                <td>${r.omega}</td>
                <td>${r.Fc}</td>
                <td>${r.limit}</td>
                <td style="color:${r.result==='å¤±æ§'?'red':'green'}; font-weight:bold;">${r.result}</td>
            </tr>
        `).join('');
        document.getElementById('recordModal').style.display = "block";
    }

    function closeModal(id) { document.getElementById(id).style.display = "none"; }
    function clearRecords() { if(confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) { records = []; openRecordModal(); } }

    function checkQuiz(btn, isCorrect) {
        const feedback = document.getElementById('quiz-feedback');
        if(isCorrect) {
            feedback.innerText = "âœ… æ­£ç¢ºï¼F = mÏ‰Â²rï¼ŒåŠ›èˆ‡ Ï‰ å¹³æ–¹æˆæ­£æ¯”ã€‚";
            feedback.style.color = "var(--accent-green)";
            btn.style.background = "var(--accent-green)"; btn.style.color="white";
        } else {
            feedback.innerText = "âŒ éŒ¯èª¤ï¼Œè«‹åƒè€ƒ F = mÏ‰Â²r å…¬å¼ã€‚";
            feedback.style.color = "var(--accent-red)";
            btn.style.background = "var(--accent-red)"; btn.style.color="white";
        }
    }

    window.addEventListener('resize', resize);
    window.onclick = function(e) { if(e.target == document.getElementById('recordModal')) closeModal('recordModal'); };
    resize();
    updateMaxForce();
    updateParams();
    animate();

</script>
</body>
</html>