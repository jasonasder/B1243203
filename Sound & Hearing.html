<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ç‰©ç†å¯¦é©—å®¤ - è²æ³¢èˆ‡è½è¦º</title>
    <style>
        :root {
            --nav-bg: #2c3e50;
            --theory-bg: rgba(255, 255, 255, 0.98);
            --lab-bg: #2b323a;
            --accent-green: #51cf66; 
            --accent-blue: #339af0;
            --accent-orange: #ff922b;
            --accent-purple: #cc5de8;
            --accent-red: #fa5252;
            --text-main: #343a40;
        }
        
        * { box-sizing: border-box; }
        body {
            margin: 0; padding: 0;
            font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
            background: url('img/bb.webp') no-repeat center center fixed;
            background-size: cover;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        nav {
            height: 60px; background: var(--nav-bg);
            display: flex; align-items: center; padding: 0 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 100;
        }
        nav a { color: #dee2e6; text-decoration: none; margin-right: 25px; font-weight: bold; font-size: 15px; transition: 0.3s; }
        nav a:hover { color: var(--accent-green); }
        nav a.active { color: var(--accent-green); border-bottom: 2px solid var(--accent-green); }

        #main-container {
            flex-grow: 1; display: flex; padding: 15px; gap: 15px;
            height: calc(100vh - 60px);
        }
        #theory-card {
            width: 400px; background: var(--theory-bg);
            border-radius: 12px; padding: 20px; overflow-y: auto;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }

        #experiment-card {
            flex-grow: 1; background: var(--theory-bg);
            border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; overflow: hidden;
        }

        #exp-header {
            padding: 20px 25px; background: #f8f9fa; 
            border-bottom: 1px solid #dee2e6;
            display: flex; align-items: center; gap: 20px; flex-wrap: wrap;
        }

        .control-group { display: flex; flex-direction: column; align-items: flex-start; gap: 4px; margin-right: 15px; }
        .slider-label { font-size: 12px; font-weight: bold; color: #555; }
        
        input[type="range"] { 
            width: 240px; 
            cursor: pointer; height: 6px; border-radius: 3px; background: #dee2e6; outline: none; appearance: none; 
        }
        input[type="range"]::-webkit-slider-thumb { appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--accent-blue); cursor: pointer; transition: 0.2s; }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        
        .control-group.danger .slider-label { color: var(--accent-red); }
        .control-group.danger input[type="range"]::-webkit-slider-thumb { background: var(--accent-red); }

        select {
            appearance: none; background-color: #fff; border: 1px solid #ced4da;
            border-radius: 6px; padding: 6px 30px 6px 12px; font-size: 14px;
            color: #495057; cursor: pointer;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat; background-position: right 8px center; background-size: 14px;
        }
        select:focus { outline: none; border-color: var(--accent-blue); }

        button { 
            background: var(--accent-blue); color: white; border: none; padding: 8px 18px; 
            border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 13px;
        }
        button:hover { background: #228be6; transform: translateY(-2px); }
        .btn-play { background: var(--accent-green); width: 100px; font-size: 14px; }
        .btn-play.playing { background: var(--accent-red); animation: pulse 2s infinite; }
        .btn-record { background: var(--accent-purple); }
        .btn-record:hover { background: #be4bdb; }

        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(250, 82, 82, 0.7);} 70% {box-shadow: 0 0 0 10px rgba(250, 82, 82, 0);} 100% {box-shadow: 0 0 0 0 rgba(250, 82, 82, 0);} }

        #canvas-container {
            flex-grow: 1; position: relative;
            background: var(--lab-bg); margin: 10px;
            border-radius: 8px; border: 1px solid #454d55; overflow: hidden;
            display: flex; flex-direction: column;
        }
        canvas { width: 100%; display: block; }
        #waveCanvas { flex: 2; border-bottom: 1px solid #444; }
        #freqCanvas { flex: 1; background: rgba(0,0,0,0.2); }

        #telemetry {
            position: absolute; top: 15px; right: 15px;
            background: rgba(33, 37, 41, 0.9); 
            color: #ecf0f1; 
            padding: 15px; border-radius: 6px; font-family: 'Consolas', monospace;
            font-size: 14px; border-left: 4px solid var(--accent-green);
            min-width: 200px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .info-btn {
            position: absolute; top: 5px; right: 5px;
            width: 20px; height: 20px; border-radius: 50%;
            background: rgba(255,255,255,0.2); color: #fff;
            font-size: 12px; line-height: 20px; text-align: center;
            cursor: pointer; font-family: sans-serif; font-weight: bold;
            pointer-events: auto;
        }
        .info-btn:hover { background: var(--accent-blue); }

        .modal {
            display: none; position: fixed; z-index: 2000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); backdrop-filter: blur(3px);
        }
        .modal-content {
            background-color: #fff; margin: 10% auto; padding: 25px;
            border-radius: 12px; width: 60%; max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4); animation: slideIn 0.3s;
        }
        @keyframes slideIn { from {transform: translateY(-50px); opacity:0;} to {transform: translateY(0); opacity:1;} }
        
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 15px;
        }
        .close-btn { font-size: 28px; cursor: pointer; color: #aaa; }
        .close-btn:hover { color: #000; }
        
        #success-toast {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(40, 40, 40, 0.95); color: white;
            padding: 20px 40px; border-radius: 10px; text-align: center;
            display: none; z-index: 2000; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: fadeInOut 1.5s ease-in-out;
        }
        .checkmark { font-size: 40px; color: var(--accent-green); display: block; margin-bottom: 10px; }
        h1 { font-size: 40px; color: var(--text-main); margin: 0 0 10px 0; border-bottom: 3px solid var(--accent-green); padding-bottom: 5px; }
        h2 { font-size: 20px; color: #1a5276; margin-top: 20px; border-left: 5px solid #1a5276; padding-left: 10px; }
        p { color: #444; line-height: 1.6; font-size: 16px; text-align: justify; margin: 5px 0; }
        
        .formula-box { 
            background: #f8f9fa; padding: 12px; border-radius: 6px; 
            font-size: 15px; border: 1px solid #e9ecef; margin-top: 8px; 
            font-family: "Times New Roman", serif; line-height: 1.6;
        }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background-color: var(--nav-bg); color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }

        #quiz-area button { width: 100%; margin: 5px 0; text-align: left; background: #e9ecef; color: #333; }
        #quiz-area button:hover { background: #dee2e6; transform: none; }
    </style>
</head>
<body>

<div id="main-container">
    <div id="theory-card">
        <h1>è²æ³¢èˆ‡è½è¦º</h1>
        
        <h2>å®šå¾‹å…§å®¹</h2>
        <p>è²éŸ³æ˜¯ç”±ç‰©é«”æŒ¯å‹•ç”¢ç”Ÿçš„ç¸±æ³¢ (Longitudinal Wave)ã€‚</p>
        <p>äººè€³å°è²éŸ³çš„æ„Ÿå—ä¸»è¦å–æ±ºæ–¼å…©å€‹ç‰©ç†é‡ï¼š<b>é »ç‡</b>æ±ºå®šéŸ³é«˜ (Pitch)ï¼Œ<b>æŒ¯å¹…</b>æ±ºå®šéŸ¿åº¦ (Loudness)ã€‚</p>
        
        <h2>å…¬å¼è¡¨ç¤º</h2>
        <div class="formula-box">
            <b>æ³¢å‡½æ•¸ï¼š</b><br>
            y(t) = A Â· sin(2Ï€ft)<br>
            <b>ç‰©ç†é‡ï¼š</b><br>
            Aï¼šæŒ¯å¹… (å°æ‡‰éŸ³é‡ dB)<br>
            fï¼šé »ç‡ (Hz, 1/T)
        </div>

        <h2>è½è¦ºç¯„åœ</h2>
        <p>
            <b>äººè€³å¯è½ï¼š</b> 20 Hz ~ 20,000 Hz<br>
            <b>æ¬¡è²æ³¢ï¼š</b> < 20 Hz (å¦‚åœ°éœ‡æ³¢)<br>
            <b>è¶…éŸ³æ³¢ï¼š</b> > 20,000 Hz (å¦‚è™è å°èˆª)
        </p>

        <h2>å¸¸è¦‹æ‡‰ç”¨</h2>
        <p>1. <b>éŸ³æ¨‚è²å­¸ï¼š</b> æ¨™æº–éŸ³é«˜ A4 = 440 Hzã€‚<br>
           2. <b>é†«å­¸æª¢æ¸¬ï¼š</b> è¶…éŸ³æ³¢æƒæ (Ultrasound)ã€‚<br>
           3. <b>å™ªéŸ³å·¥ç¨‹ï¼š</b> è²æ³¢åç›¸æŠµæ¶ˆæŠ€è¡“ (é™å™ªè€³æ©Ÿ)ã€‚</p>
        <div class="formula-box" style="border-left: 4px solid var(--accent-purple); background: #f3f0ff;">
          <h3>ğŸš€ å¼•å°è§€å¯Ÿä»»å‹™</h3>
          <p><b>1. éŸ³è‰²çš„ç§˜å¯†ï¼š</b><br>
          å°‡é »ç‡è¨­ç‚º 440Hzï¼Œåˆ‡æ› <b>æ­£å¼¦æ³¢</b> èˆ‡ <b>æ–¹æ³¢</b>ã€‚è«‹è§€å¯Ÿä¸‹æ–¹çš„ã€Œé »è­œåˆ†æã€æœ‰ä»€éº¼ä¸åŒï¼Ÿï¼ˆæç¤ºï¼šæ–¹æ³¢æœƒå¤šå‡ºè¨±å¤šæŸ±ç‹€æ³›éŸ³ï¼‰ã€‚</p>
          <p><b>2. è½åŠ›æ¥µé™ï¼š</b><br>
          æˆ´ä¸Šè€³æ©Ÿï¼Œå°‡é »ç‡å¾ 10,000Hz æ…¢æ…¢å¾€ä¸Šæ‹‰ï¼Œä½ åœ¨å¤šå°‘ Hz ä¹‹å¾Œå°±è½ä¸è¦‹äº†ï¼Ÿ</p>
        </div>
        <h2>éš¨å ‚æ¸¬é©—</h2>
        <div id="quiz-area" style="font-size: 14px; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
            <p><b>Q1: é »ç‡è¶Šé«˜ï¼Œæˆ‘å€‘è½åˆ°çš„è²éŸ³æœƒæœ‰ä»€éº¼è®ŠåŒ–ï¼Ÿ</b></p>
            <button onclick="checkQuiz(this, false)">è²éŸ³è®Šå¤§è²</button>
            <button onclick="checkQuiz(this, true)">éŸ³èª¿è®Šé«˜å°–</button>
            <button onclick="checkQuiz(this, false)">å‚³æ’­é€Ÿåº¦è®Šå¿«</button>
            <p id="quiz-feedback" style="margin-top:10px; font-weight:bold;"></p>
        </div>
    </div>

    <div id="experiment-card">
        <div id="exp-header">
            <div class="control-group">
                <span class="slider-label">é »ç‡ f: <span id="freqDisp">440</span> Hz</span>
                <input type="range" id="freq" min="20" max="5000" step="1" value="440" oninput="updateParams()">
            </div>
            
            <div class="control-group" id="amp-group">
                <span class="slider-label">æŒ¯å¹… (éŸ³é‡): <span id="ampDisp">0.5</span></span>
                <input type="range" id="amp" min="0" max="1.0" step="0.01" value="0.5" oninput="updateParams()">
            </div>

            <div class="control-group">
                 <span class="slider-label">æ³¢å½¢ç¨®é¡</span>
                 <select id="waveType" onchange="updateWaveType()">
                     <option value="sine">æ­£å¼¦æ³¢ (Sine)</option>
                     <option value="square">æ–¹æ³¢ (Square)</option>
                     <option value="sawtooth">é‹¸é½’æ³¢ (Saw)</option>
                     <option value="triangle">ä¸‰è§’æ³¢ (Triangle)</option>
                 </select>
            </div>

            <div style="margin-left:auto; display:flex; gap:8px;">
                <button class="btn-play" id="playBtn" onclick="toggleSound()">â–¶ æ’­æ”¾</button>
                <button class="btn-record" onclick="recordData()">ç´€éŒ„</button>
                <button onclick="openModal('recordModal')" style="background: #333;">ç´€éŒ„ç°¿</button>
            </div>
        </div>

        <div id="canvas-container">
            <div id="success-toast"><span class="checkmark">âœ”</span><div>æ•¸æ“šå·²æˆåŠŸç´€éŒ„</div></div>
            
            <div id="telemetry">
                <div class="info-btn" onclick="openModal('telemetryHelpModal')">?</div>
                <span style="color:var(--accent-green)">Frequency:</span> <span id="tel-freq" style="color:white; font-weight:bold;">440</span> Hz<br>
                <span style="color:var(--accent-blue)">Pitch:</span> <span id="tel-note" style="color:white; font-weight:bold;">A4</span><br>
                <span style="color:var(--accent-orange)">Gain:</span> <span id="tel-gain" style="color:white; font-weight:bold;">-6.0</span> dB<br>
                <hr style="border-color:#555; margin:5px 0;">
                <div id="status-msg" style="font-size: 12px; color: #51cf66;">ç‹€æ…‹: æ­£å¸¸</div>
            </div>
            
            <canvas id="waveCanvas"></canvas>
            <canvas id="freqCanvas"></canvas>
            
            <div style="position:absolute; bottom:5px; left:10px; color:#666; font-size:10px;">
                * ä¸Šæ–¹ï¼šæ™‚åŸŸæ³¢å½¢ (Time Domain) | ä¸‹æ–¹ï¼šé »è­œåˆ†æ (Frequency Domain)
            </div>
        </div>
    </div>
</div>

<div id="recordModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 style="margin:0;">ğŸ“” å¯¦é©—ç´€éŒ„ç°¿</h2>
            <div style="display: flex; gap: 15px; align-items: center;">
                <button onclick="clearRecords()" style="background: var(--accent-red); padding: 5px 15px; font-size: 13px;">æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button>
                <span class="close-btn" onclick="closeModal('recordModal')">&times;</span>
            </div>
        </div>
        <table id="recordTable">
            <thead>
                <tr>
                    <th>æ™‚é–“</th>
                    <th>é »ç‡ (Hz)</th>
                    <th>éŸ³é«˜</th>
                    <th>æŒ¯å¹…</th>
                    <th>æ³¢å½¢</th>
                </tr>
            </thead>
            <tbody id="recordBody"></tbody>
        </table>
    </div>
</div>

<div id="telemetryHelpModal" class="modal">
    <div class="modal-content" style="max-width:500px;">
        <div class="modal-header">
            <h2 style="margin:0; color:var(--accent-blue);">ğŸ“Š æ•¸æ“šé¢æ¿èªªæ˜</h2>
            <span class="close-btn" onclick="closeModal('telemetryHelpModal')">&times;</span>
        </div>
        <div style="font-size: 15px; line-height: 1.6; color: #444;">
            <p><b>1. Frequency (é »ç‡):</b><br>
            è²æ³¢æ¯ç§’æŒ¯å‹•çš„æ¬¡æ•¸ï¼Œå–®ä½ç‚ºèµ«èŒ² (Hz)ã€‚æ•¸å€¼è¶Šé«˜ï¼Œè½èµ·ä¾†è¶Šå°–éŠ³ã€‚</p>
            
            <p><b>2. Pitch (éŸ³é«˜):</b><br>
            å°æ‡‰éŸ³æ¨‚ä¸­çš„éŸ³å (å¦‚ C4, A4)ã€‚å¹«åŠ©ä½ å°‡ç‰©ç†é »ç‡é€£çµåˆ°éŸ³æ¨‚æ¦‚å¿µã€‚<br>
            <span style="color:#666; font-size:13px;">* A4 = 440Hz (æ¨™æº–éŸ³é«˜)</span></p>
            
            <p><b>3. Gain (å¢ç›Š/éŸ³é‡):</b><br>
            ä»¥åˆ†è² (dB) è¡¨ç¤ºçš„éŸ³é‡å¤§å°ã€‚0 dB ç‚ºæœ€å¤§è¼¸å‡ºï¼Œè² å€¼è¡¨ç¤ºè¡°æ¸›ã€‚</p>
        </div>
        <button onclick="closeModal('telemetryHelpModal')" style="width:100%; margin-top:15px;">ç­è§£</button>
    </div>
</div>

<div id="warningModal" class="modal">
    <div class="modal-content" style="max-width:400px; border:2px solid var(--accent-red);">
        <div class="modal-header">
            <h2 style="margin:0; color:var(--accent-red);">âš ï¸ éŸ³é‡è­¦å‘Š</h2>
            <span class="close-btn" onclick="closeModal('warningModal')">&times;</span>
        </div>
        <p>æ‚¨ç›®å‰çš„éŸ³é‡è¨­å®šéé«˜ï¼Œå¯èƒ½æœƒé€ æˆè½è¦ºä¸é©æˆ–è¨­å‚™å—æã€‚</p>
        <p>ç³»çµ±å·²è‡ªå‹•é™åˆ¶æœ€å¤§è¼¸å‡ºã€‚</p>
        <button onclick="closeModal('warningModal')" style="width:100%; margin-top:10px;">æˆ‘ç­è§£äº†</button>
    </div>
</div>

<script>
    // Canvas Setup
    const waveCanvas = document.getElementById('waveCanvas');
    const freqCanvas = document.getElementById('freqCanvas');
    const ctxWave = waveCanvas.getContext('2d');
    const ctxFreq = freqCanvas.getContext('2d');

    // Audio Context
    let audioCtx;
    let oscillator;
    let gainNode;
    let analyser;
    let isPlaying = false;

    // Parameters
    let freq = 440;
    let amp = 0.5;
    let waveType = 'sine';

    // Records
    let records = [];

    const noteStrings = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 2048;
        }
    }

    function resize() {
        const container = document.getElementById('canvas-container');
        waveCanvas.width = container.clientWidth;
        waveCanvas.height = container.clientHeight * 0.66;
        freqCanvas.width = container.clientWidth;
        freqCanvas.height = container.clientHeight * 0.33;
    }

    function toggleSound() {
        initAudio();
        
        if (isPlaying) {
            stopSound();
        } else {
            startSound();
        }
    }

    function startSound() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        
        oscillator = audioCtx.createOscillator();
        gainNode = audioCtx.createGain();

        oscillator.type = waveType;
        oscillator.frequency.value = freq;
        gainNode.gain.value = amp;

        oscillator.connect(gainNode);
        gainNode.connect(analyser);
        analyser.connect(audioCtx.destination);

        oscillator.start();
        isPlaying = true;
        
        document.getElementById('playBtn').innerHTML = "â–  åœæ­¢";
        document.getElementById('playBtn').classList.add('playing');
        
        draw();
    }

    function stopSound() {
        if (oscillator) {
            oscillator.stop();
            oscillator.disconnect();
        }
        isPlaying = false;
        document.getElementById('playBtn').innerHTML = "â–¶ æ’­æ”¾";
        document.getElementById('playBtn').classList.remove('playing');
    }

    function updateParams() {
        freq = parseFloat(document.getElementById('freq').value);
        amp = parseFloat(document.getElementById('amp').value);
        
        // UI Updates
        document.getElementById('freqDisp').innerText = freq;
        document.getElementById('ampDisp').innerText = amp.toFixed(2);
        
        // Warning Check
        const ampGroup = document.getElementById('amp-group');
        const statusEl = document.getElementById('status-msg');
        
        if (amp > 0.8) {
            ampGroup.classList.add('danger');
            statusEl.innerHTML = "ç‹€æ…‹: <b style='color:var(--accent-red)'>éŸ³é‡éå¤§ (High Volume)</b>";
        } else {
            ampGroup.classList.remove('danger');
            statusEl.innerHTML = "ç‹€æ…‹: <span style='color:var(--accent-green)'>æ­£å¸¸ (Normal)</span>";
        }

        // Pitch Calculation
        const note = getNoteFromFreq(freq);
        document.getElementById('tel-freq').innerText = freq;
        document.getElementById('tel-note').innerText = note;
        const db = amp > 0 ? (20 * Math.log10(amp)).toFixed(1) : "-Inf";
        document.getElementById('tel-gain').innerText = db + " dB";

        // Audio Update
        if (isPlaying && oscillator) {
            oscillator.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(amp, audioCtx.currentTime);
        }
    }

    function updateWaveType() {
        waveType = document.getElementById('waveType').value;
        if (isPlaying && oscillator) {
            oscillator.type = waveType;
        }
    }

    function getNoteFromFreq(frequency) {
        const noteNum = 12 * (Math.log(frequency / 440) / Math.log(2));
        const noteIndex = Math.round(noteNum) + 69;
        const octave = Math.floor(noteIndex / 12) - 1;
        const noteName = noteStrings[noteIndex % 12];
        return noteName + octave;
    }

    // --- Visualization Loop ---
    function draw() {
        if (!isPlaying) {
             ctxWave.fillStyle = '#2b323a';
             ctxWave.fillRect(0, 0, waveCanvas.width, waveCanvas.height);
             ctxWave.beginPath();
             ctxWave.strokeStyle = '#51cf66';
             ctxWave.moveTo(0, waveCanvas.height/2);
             ctxWave.lineTo(waveCanvas.width, waveCanvas.height/2);
             ctxWave.stroke();
             ctxFreq.clearRect(0,0,freqCanvas.width, freqCanvas.height);
             return;
        }
        
        requestAnimationFrame(draw);

        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        
        // 1. Draw Waveform
        analyser.getByteTimeDomainData(dataArray);
        
        ctxWave.fillStyle = '#2b323a';
        ctxWave.fillRect(0, 0, waveCanvas.width, waveCanvas.height);
        ctxWave.lineWidth = 2;
        ctxWave.strokeStyle = '#51cf66';
        ctxWave.beginPath();

        const sliceWidth = waveCanvas.width * 1.0 / bufferLength;
        let x = 0;

        for (let i = 0; i < bufferLength; i++) {
            const v = dataArray[i] / 128.0;
            const y = v * waveCanvas.height / 2;

            if (i === 0) ctxWave.moveTo(x, y);
            else ctxWave.lineTo(x, y);

            x += sliceWidth;
        }
        ctxWave.lineTo(waveCanvas.width, waveCanvas.height / 2);
        ctxWave.stroke();

        // 2. Draw Frequency
        const freqData = new Uint8Array(bufferLength);
        analyser.getByteFrequencyData(freqData);

        ctxFreq.clearRect(0, 0, freqCanvas.width, freqCanvas.height);
        const barWidth = (freqCanvas.width / bufferLength) * 2.5;
        let barX = 0;

        for (let i = 0; i < bufferLength; i++) {
            const barHeight = freqData[i] / 255 * freqCanvas.height;
            ctxFreq.fillStyle = `hsl(${i/bufferLength * 360}, 100%, 50%)`;
            ctxFreq.fillRect(barX, freqCanvas.height - barHeight, barWidth, barHeight);
            barX += barWidth + 1;
        }
    }

    // --- Data Recording & Modals ---
    function recordData() {
        const note = getNoteFromFreq(freq);
        records.push({
            time: new Date().toLocaleTimeString(),
            freq: freq, note: note, amp: amp, type: waveType
        });
        
        const toast = document.getElementById('success-toast');
        toast.style.display = 'block';
        toast.style.animation = 'none';
        toast.offsetHeight;
        toast.style.animation = 'fadeInOut 1.5s ease-in-out';
        setTimeout(() => { toast.style.display = 'none'; }, 1500);
    }

    function openModal(id) { document.getElementById(id).style.display = "block"; }
    function closeModal(id) { document.getElementById(id).style.display = "none"; }
    
    function clearRecords() { if(confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) { records = []; openModal('recordModal'); } }

    function checkQuiz(btn, isCorrect) {
        const feedback = document.getElementById('quiz-feedback');
        if(isCorrect) {
            feedback.innerText = "âœ… æ­£ç¢ºï¼é »ç‡æ±ºå®šéŸ³é«˜ (Pitch)ã€‚";
            feedback.style.color = "var(--accent-green)";
            btn.style.background = "var(--accent-green)"; btn.style.color="white";
        } else {
            feedback.innerText = "âŒ éŒ¯èª¤ã€‚è²éŸ³å¤§å°ç”±æŒ¯å¹…æ±ºå®šï¼Œé€Ÿåº¦ç”±ä»‹è³ªæ±ºå®šã€‚";
            feedback.style.color = "var(--accent-red)";
            btn.style.background = "var(--accent-red)"; btn.style.color="white";
        }
    }

    window.addEventListener('resize', resize);
    window.onclick = function(e) { 
        if(e.target.classList.contains('modal')) e.target.style.display = 'none';
    };
    resize();
    updateParams();
    draw(); 
</script>
</body>
</html>